From 58721a31e344a9b0def4ff48625a1001a0281294 Mon Sep 17 00:00:00 2001
From: SVN-Git Migration <python-modules-team@lists.alioth.debian.org>
Date: Thu, 8 Oct 2015 14:09:59 -0700
Subject: use_pybuild_buildsystem

Patch-Name: use_pybuild_buildsystem.patch
---
 stdeb/util.py | 96 +++++------------------------------------------------------
 1 file changed, 8 insertions(+), 88 deletions(-)

diff --git a/stdeb/util.py b/stdeb/util.py
index f434e76..fec729e 100644
--- a/stdeb/util.py
+++ b/stdeb/util.py
@@ -790,7 +790,7 @@ class DebianInfo:
         self.uploaders = parse_vals(cfg,module_name,'Uploaders')
         self.date822 = get_date_822()
 
-        build_deps = []
+        build_deps = ['dh-python']
         if use_setuptools:
             if with_python2:
                 build_deps.append('python-setuptools (>= 0.6b3)')
@@ -1066,36 +1066,10 @@ class DebianInfo:
         else:
             self.install_prefix = ''
 
-        rules_override_clean_target_pythons = []
-        rules_override_build_target_pythons = []
-        rules_override_install_target_pythons = []
-        if with_python2:
-            rules_override_clean_target_pythons.append(
-                RULES_OVERRIDE_CLEAN_TARGET_PY2%self.__dict__
-                )
-            rules_override_build_target_pythons.append(
-                RULES_OVERRIDE_BUILD_TARGET_PY2%self.__dict__
-                )
-            rules_override_install_target_pythons.append(
-                RULES_OVERRIDE_INSTALL_TARGET_PY2%self.__dict__
-                )
-        if with_python3:
-            rules_override_clean_target_pythons.append(
-                RULES_OVERRIDE_CLEAN_TARGET_PY3%self.__dict__
-                )
-            rules_override_build_target_pythons.append(
-                RULES_OVERRIDE_BUILD_TARGET_PY3%self.__dict__
-                )
-            rules_override_install_target_pythons.append(
-                RULES_OVERRIDE_INSTALL_TARGET_PY3%self.__dict__
-                )
-        self.rules_override_clean_target_pythons = '\n'.join(rules_override_clean_target_pythons)
-        self.rules_override_build_target_pythons = '\n'.join(rules_override_build_target_pythons)
-        self.rules_override_install_target_pythons = '\n'.join(rules_override_install_target_pythons)
-
-        self.override_dh_auto_clean = RULES_OVERRIDE_CLEAN_TARGET%self.__dict__
-        self.override_dh_auto_build = RULES_OVERRIDE_BUILD_TARGET%self.__dict__
-        self.override_dh_auto_install = RULES_OVERRIDE_INSTALL_TARGET%self.__dict__
+        if self.scripts_cleanup:
+            self.override_dh_auto_install = RULES_OVERRIDE_INSTALL_TARGET%self.__dict__
+        else:
+            self.override_dh_auto_install = ''
 
         if force_x_python3_version and with_python3 and x_python3_version and \
                 x_python3_version[0]:
@@ -1104,21 +1078,13 @@ class DebianInfo:
             version = x_python3_version[0]
             if not version.endswith('~'):
                 version += '~'
-            self.override_dh_python3 = RULES_OVERRIDE_PYTHON3%{
-                'scripts': (
-                    '        sed -i ' +
-                    '"s/\([ =]python3:any (\)>= [^)]*\()\)/\\1%s\\2/g" ' +
-                    'debian/%s.substvars') % (version, self.package3)
-            }
-        else:
-            self.override_dh_python3 = ''
 
         sequencer_options = ['--with '+','.join(sequencer_with)]
-        sequencer_options.append('--buildsystem=python_distutils')
+        sequencer_options.append('--buildsystem=pybuild')
         self.sequencer_options = ' '.join(sequencer_options)
 
         setup_env_vars = parse_vals(cfg,module_name,'Setup-Env-Vars')
-        self.exports = ""
+        self.exports = "export PYBUILD_NAME=%s" % self.source
         if len(setup_env_vars):
             self.exports += '\n'
             self.exports += '#exports specified using stdeb Setup-Env-Vars:\n'
@@ -1342,10 +1308,6 @@ def build_dsc(debinfo,
     fd.write('3.0 (quilt)\n')
     fd.close()
 
-    fd = open( os.path.join(debian_dir,'source','options'), mode='w')
-    fd.write('extend-diff-ignore="\.egg-info$"')
-    fd.close()
-
     if debian_dir_only:
         return
 
@@ -1477,59 +1439,17 @@ RULES_MAIN = """\
 %(percent_symbol)s:
         dh $@ %(sequencer_options)s
 
-%(override_dh_auto_clean)s
-
-%(override_dh_auto_build)s
-
 %(override_dh_auto_install)s
 
-override_dh_python2:
-        dh_python2 --no-guessing-versions
-
-%(override_dh_python3)s
-
 %(binary_target_lines)s
 """
 
-RULES_OVERRIDE_CLEAN_TARGET_PY2 = "        python setup.py clean -a"
-RULES_OVERRIDE_CLEAN_TARGET_PY3 = "        python3 setup.py clean -a"
-RULES_OVERRIDE_CLEAN_TARGET = """
-override_dh_auto_clean:
-%(rules_override_clean_target_pythons)s
-        find . -name \*.pyc -exec rm {} \;
-"""
-
-RULES_OVERRIDE_BUILD_TARGET_PY2 = "        python setup.py build --force"
-RULES_OVERRIDE_BUILD_TARGET_PY3 = "        python3 setup.py build --force"
-RULES_OVERRIDE_BUILD_TARGET = """
-override_dh_auto_build:
-%(rules_override_build_target_pythons)s
-"""
-
-RULES_OVERRIDE_INSTALL_TARGET_PY2 = "        python setup.py install --force --root=debian/%(package)s --no-compile -O0 --install-layout=deb %(install_prefix)s %(no_python2_scripts_cli_args)s"
-
-RULES_OVERRIDE_INSTALL_TARGET_PY3 = "        python3 setup.py install --force --root=debian/%(package3)s --no-compile -O0 --install-layout=deb %(install_prefix)s %(no_python3_scripts_cli_args)s"
-
 RULES_OVERRIDE_INSTALL_TARGET = """
 override_dh_auto_install:
-%(rules_override_install_target_pythons)s
+    dh_auto_install
 %(scripts_cleanup)s
 """
 
-RULES_OVERRIDE_PYTHON3 = """
-override_dh_python3:
-        dh_python3
-%(scripts)s
-"""
-
-RULES_BINARY_TARGET = """
-binary: binary-arch binary-indep
-"""
-
-RULES_BINARY_ALL_TARGET = """
-binary: binary-indep
-"""
-
 RULES_BINARY_ARCH_TARGET = """
 binary-arch: build
 %(dh_binary_arch_lines)s
